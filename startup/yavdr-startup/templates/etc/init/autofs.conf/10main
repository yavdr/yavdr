description     "Automounter"
author          "yaVDR-team based Chuck Short <zulcss@ubuntu.com>"

start on (filesystem
        and net-device-up IFACE!=lo)
stop on ( starting rc and runlevel [016] )

console output
expect fork
respawn

pre-start script
        if [ -f /etc/default/autofs ]; then
                . /etc/default/autofs
        fi

        if ! grep -q autofs /proc/filesystems
        then
                # Try load the autofs4 module fail if we can't
                if ! modprobe autofs4 >/dev/null 2>&1
                then
                        echo "Error: failed to load autofs4 module."
                        exit 1
                fi
        elif ([ -f /proc/modules ] && lsmod) | grep -q autofs[^4]
        then
                # wrong autofs filesystem module loaded
                echo "Error: autofs kernel module is loaded, autofs4 required"
                exit 1
        fi

        if [ -n "$USE_MISC_DEVICE" -a "x$USE_MISC_DEVICE" = "xyes" ]; then
                sleep 1
                if [ -e "/proc/misc" ]; then
                        MINOR=`awk "/autofs/ {print \\$1}" /proc/misc`
                        if [ -n "$MINOR" -a ! -c "/dev/autofs" ]; then
                                mknod -m 0600 /dev/autofs c 10 $MINOR
                        fi
                fi
                if [ -x /sbin/restorecon -a -c /dev/autofs ]; then
                        /sbin/restorecon /dev/autofs
                fi
        else
                if [ -c /dev/autofs ]; then
                        rm /dev/autofs
                fi
        fi


end script

script
        if [ -f /etc/default/autofs ]; then
                . /etc/default/autofs
        fi

        if [ -n "$TIMEOUT" ]; then 
           OPTIONS=" -t $TIMEOUT $OPTIONS"
        fi 

        exec /usr/sbin/automount $OPTIONS
end script
