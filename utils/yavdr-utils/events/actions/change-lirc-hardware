#!/bin/bash

LIRCD="$(dbget system.remoted)"
LIRCD_CONF="$(dbget system.lirchw.lircd_conf)"
if [ "$LIRCD" = "lircd" ]; then
  if [ -n "$LIRCD_CONF" ]; then
    rm -f /etc/lirc/lircd.conf
    if [ -e /usr/share/lirc/remotes/$LIRCD_CONF ]; then
      ln -sf /usr/share/lirc/remotes/$LIRCD_CONF /etc/lirc/lircd.conf
    elif [ -e /usr/share/lirc/extras/more_remotes/$LIRCD_CONF ]; then
      ln -sf /usr/share/lirc/extras/more_remotes/$LIRCD_CONF /etc/lirc/lircd.conf
    fi
  fi
else 
  rm -f /etc/modprobe.d/lirc-blacklist.conf
  rm -f /etc/modprobe.d/lirc-serial.conf
  rm -f /etc/serial.conf
fi 

if [ "x$LIRCD" = "xirserver" ]; then
  process-template --mode 755 /etc/pm/sleep.d/30irserver
  process-template --owner=vdr --group=vdr /var/lib/vdr/remote.conf
else
  rm -f /etc/pm/sleep.d/30irserver
fi
 
#For atilibusb, we need to blacklist the kernel module
for MODULE in `dbget system.lirchw.driver` ; do 
if [ "$MODULE" = "atilibusb" ]; then
   BLACKLIST="lirc_atiusb ati_remote"
elif [ "$MODULE" = "atiusb" ]; then
   BLACKLIST="ati_remote"
else
   BLACKLIST=""
fi
done 

cat <<EOF > /etc/modprobe.d/lirc-blacklist.conf
# This file is automatically generated by yavdr webfrontend
# Please expect this file to be overwritten on lirc
# reconfiguration at webfrontend

EOF

if [ -n "$BLACKLIST" ]; then

MODULE=""
for MODULE in $BLACKLIST ; do 
    echo "blacklist $MODULE" >> /etc/modprobe.d/lirc-blacklist.conf 
    modprobe -r $MODULE 
done 
fi 
