#!/bin/bash

rm -f /etc/lirc/lircd.conf

LIRCD="$(dbget system.remoted)"
LIRCD_CONF="$(dbget system.lirchw.lircd_conf)"
if [ "x$LIRCD" = "xlircd" ]; then
  if [ -n $LIRCD_CONF ]; then 
    if [ -e /usr/share/lirc/remotes/$LIRCD_CONF ]; then
      ln -sf /usr/share/lirc/remotes/$LIRCD_CONF /etc/lirc/lircd.conf
    elif [ -e /usr/share/lirc/extras/more_remotes/$LIRCD_CONF ]; then
      ln -sf /usr/share/lirc/extras/more_remotes/$LIRCD_CONF /etc/lirc/lircd.conf
    fi
  fi
else 
  rm -f /etc/modprobe.d/lirc-blacklist.conf
  rm -f /etc/modprobe.d/lirc-serial.conf
  rm -f /etc/serial.conf
fi 

#For atilibusb, we need to blacklist the kernel module
for MODULE in `dbget system.lirchw.driver` ; do 
if [ "x$MODULE" = "xatilibusb" ]; then
   BLACKLIST="lirc_atiusb ati_remote"
elif [ "x$MODULE" = "xatiusb" ]; then
   BLACKLIST="ati_remote"
else
   BLACKLIST=""
fi
done 

cat <<EOF > /etc/modprobe.d/lirc-blacklist.conf
# This file is automatically generated by yavdr webfrontend
# Please expect this file to be overwritten on lirc
# reconfiguration at webfrontend

EOF

if [ ! -z $BLACKLIST ]; then
MODULE=""
for MODULE in $BLACKLIST ; do 
    echo "blacklist $MODULE" >> /etc/modprobe.d/lirc-blacklist.conf 
    modprobe -r $MODULE 
done 
fi 

